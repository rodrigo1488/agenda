<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="/static/agendamentos.css">

</head>
<body>
    <div class="titulo">
        

    <h4>Selecione uma empresa para agendar um serviço</h4>
</div>
    <div id="empresas-lista"></div>
    <!-- Modal de Agendamento -->
    <div id="modal-agendamento" style="display: none;">
        <h2>Agendar Serviço</h2>
        <form id="form-agendamento">
            <input type="text" name="nome" placeholder="Nome do Cliente" required />
            <input type="tel" name="telefone" placeholder="Telefone" required />
            <input type="email" name="email" placeholder="E-mail" required />
            <select name="usuario_id" required>
                <option value="">Selecione o Profissional</option>
                <!-- Populado via JavaScript -->
            </select>
            <select name="servico_id" required>
                <option value="">Selecione o Serviço</option>
                <!-- Populado via JavaScript -->
            </select>
            <input type="date" name="data" required />
            <input type="time" name="horario" required />
            <textarea name="descricao" placeholder="Descrição (opcional)"></textarea>
            <button type="submit">Agendar</button>
        </form>
    </div>
<a href="/login" class="btn btn-secondary" style="margin-top: 5%;">voltar</a>
 <script>
    async function carregarEmpresas() {
        try {
            const response = await axios.get('/api/empresas');
            const empresas = response.data;
            const lista = document.getElementById('empresas-lista');
    
            // Limpa a lista antes de popular
            lista.innerHTML = '';
    
            // Verifica se há empresas
            if (!empresas || empresas.length === 0) {
                lista.innerHTML = '<p>Nenhuma empresa encontrada.</p>';
                return;
            }
    
            empresas.forEach(empresa => {
                const item = document.createElement('div');
                item.classList.add('card'); // Adiciona a classe "card" para estilizar como um cartão
    
                // Acesse o nome correto da empresa: empresa.nome_empresa
                item.innerHTML = `
                    <div class="card-body">
                        <img src="${empresa.logo}" alt="Logo" class="logo">
                        <div class="card-text">
                        <h3 class="card-title">${empresa.nome_empresa}</h3>
                        <p class="card-text">${empresa.descricao}</p>
                        <button class="btn-agendar" onclick="abrirModalAgendamento(${empresa.id})">Agendar</button>
                        </div>
                    </div>
                `;
    
                // Adiciona o card na lista
                lista.appendChild(item);
            });
        } catch (error) {
            console.error('Erro ao carregar empresas:', error);
            alert('Erro ao carregar empresas. Tente novamente mais tarde.');
        }
    }
    

    async function carregarFuncionarios(empresaId) {
        try {
            // Corrigido para utilizar o endpoint correto
            const response = await axios.get(`/api/usuarios/${empresaId}`);
            const funcionarios = response.data;
            const selectUsuarios = document.querySelector('select[name="usuario_id"]');
    
            // Limpa o select antes de popular
            selectUsuarios.innerHTML = '<option value="">Selecione o Funcionário</option>';
    
            // Verifica se há funcionários
            if (!funcionarios || funcionarios.length === 0) {
                selectUsuarios.innerHTML = '<option value="">Nenhum funcionário disponível</option>';
                return;
            }
    
            funcionarios.forEach(funcionario => {
                const option = document.createElement('option');
                option.value = funcionario.id;
                option.textContent = funcionario.nome_usuario;
                selectUsuarios.appendChild(option);
            });
        } catch (error) {
            console.error('Erro ao carregar funcionários:', error);
            alert('Erro ao carregar funcionários. Tente novamente mais tarde.');
        }
    }
    async function carregarServicos(empresaId) {
        try {
            // Chamada para buscar os serviços da empresa
            const response = await axios.get(`/api/servicos/${empresaId}`);
            const servicos = response.data;
            const selectServicos = document.querySelector('select[name="servico_id"]');
    
            // Limpa o select antes de popular
            selectServicos.innerHTML = '<option value="">Selecione o Serviço</option>';
    
            // Verifica se há serviços
            if (!servicos || servicos.length === 0) {
                selectServicos.innerHTML = '<option value="">Nenhum serviço disponível</option>';
                return;
            }
    
            servicos.forEach(servico => {
                const option = document.createElement('option');
                option.value = servico.id;
                option.textContent = servico.nome_servico;
                selectServicos.appendChild(option);
            });
        } catch (error) {
            console.error('Erro ao carregar serviços:', error);
            alert('Erro ao carregar serviços. Tente novamente mais tarde.');
        }
    }
    
    
    function abrirModalAgendamento(empresaId) {
        carregarFuncionarios(empresaId); // Chama a função para carregar funcionários
        carregarServicos(empresaId);
        document.getElementById('modal-agendamento').style.display = 'block';
    }

    document.getElementById('form-agendamento').onsubmit = async function (e) {
        e.preventDefault();

        const dados = new FormData(e.target);
        const dadosObj = Object.fromEntries(dados.entries());

        try {
            const response = await axios.post('/api/agendar-cliente', dadosObj);
            alert(response.data.message);
            document.getElementById('modal-agendamento').style.display = 'none';
        } catch (err) {
            console.error('Erro ao agendar:', err);
            alert(err.response?.data?.error || 'Erro ao realizar o agendamento');
        }
    };

    // Inicializar a página
    carregarEmpresas();
</script>

</body>
</html>
